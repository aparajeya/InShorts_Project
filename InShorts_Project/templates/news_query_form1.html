<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Query Form</title>
</head>
<body>
    <h1>News Query System</h1>
    <p>Enter a query and choose an API endpoint to fetch news data:</p>

    <form id="news-query-form">
        {% csrf_token %}

        <!-- Input for the query -->
        <label for="input_query">Enter your query:</label>
        <input type="text" id="input_query" name="input_query" required placeholder="e.g., Latest technology news from NYT">

        <br><br>

        <!-- Dropdown for selecting API endpoint -->
        <label for="endpoint">Select API Endpoint:</label>
        <select id="endpoint" name="endpoint">
            <option value="category">Category</option>
            <option value="score">Relevance Score</option>
            <option value="search">Search</option>
            <option value="source">Source</option>
            <option value="nearby">Nearby</option>
        </select>

        <br><br>

        <!-- Optional fields based on endpoint -->
        <div id="extra-fields"></div>

        <br>
        <button type="submit">Get News</button>
    </form>

    <h2>News Results:</h2>
    <div id="response-message" style="margin-top: 20px;"></div>

    <script>
        // Handle form submission
        document.getElementById("news-query-form").addEventListener("submit", function(event) {
            event.preventDefault();

            // Get form data
            const inputQuery = document.getElementById("input_query").value;
            const endpoint = document.getElementById("endpoint").value;

            // Collect additional parameters if needed (e.g., location for 'nearby')
            let additionalParams = {};
            if (endpoint === "nearby") {
                additionalParams.lat = prompt("Enter latitude:");
                additionalParams.lon = prompt("Enter longitude:");
            } else if (endpoint === "category" || endpoint === "source") {
                additionalParams.category = prompt("Enter category/source name:");
            }

            // Construct the API URL
            const url = `/api/${endpoint}/`;

            // Send the request to the appropriate endpoint
            fetch(url, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": document.querySelector('[name="csrfmiddlewaretoken"]').value
                },
                body: JSON.stringify({
                    query: inputQuery,
                    ...additionalParams
                })
            })
            .then(response => response.json())
            .then(data => {
                let responseMessage = `<h3>Results for "${inputQuery}":</h3>`;
                if (data.articles && data.articles.length > 0) {
                    data.articles.forEach(article => {
                        responseMessage += `
                            <div>
                                <h4>${article.title}</h4>
                                <p>${article.description}</p>
                                <p><strong>Source:</strong> ${article.source_name}</p>
                                <p><strong>Category:</strong> ${article.category.join(", ")}</p>
                                <p><a href="${article.url}" target="_blank">Read More</a></p>
                            </div>
                        `;
                    });
                } else {
                    responseMessage += "<p>No articles found for this query.</p>";
                }
                document.getElementById("response-message").innerHTML = responseMessage;
            })
            .catch(error => {
                document.getElementById("response-message").innerHTML = `<p style="color: red;">Error: ${error.message}</p>`;
            });
        });
    </script>
</body>
</html>
